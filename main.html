<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>webprose</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"
        integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q=="
        crossorigin="anonymous"></script>
</head>

<body>

    <div id="editor"></div>
    <script>
        document.title = localStorage.getItem('filename');
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/text");
        editor.setKeyboardHandler("ace/keyboard/vim");
        editor.renderer.setShowGutter(false);
        editor.commands.addCommand({
            name: 'save',
            bindKey: { win: 'Ctrl-S', mac: 'Cmd-S' },
            exec: function (editor) {
                // call your save function here
                save();
            },
            readOnly: true // false if this command should not apply in readOnly mode
        });

        editor.setOptions({
            showInvisibles: false, // Disable display of invisible characters
            tabSize: 4,
            printMargin: false,
            fontSize: 24,
            indentedSoftWrap: false,
            wrap: "free",
            fontFamily: 'iawriter'

        })

        ace.config.loadModule("ace/keybinding/vim", function () { // Use Vim Here
            Vim = require("ace/keyboard/vim").Vim
            Vim.map("j", "gj", "normal")
            Vim.map("k", "gk", "normal")
        })

        //structure containing files and their names
        function File(name, content) {
            this.name = name;
            this.content = content;
        }

        var defaultName = "text.txt";
        var defaultContent = "Exceed:"; // make a function that access the content of the last file opened
        //at program initialization, create a new file obj
        function init() {
            var file = new File(defaultName, defaultContent);
            var fileJSON = JSON.stringify(file);
            localStorage.setItem(file.name, fileJSON)
            //var file = JSON.parse(fileJSON); //this parses the JSON STRING back into obj form
            editor.setValue(file.content);
        }


        init(); //instantiate the default file

        function saveText() {
            // Get the current filename from the local storage
            const filename = localStorage.getItem("filename");

            // Log the filename that is being saved
            console.log("Saving file: " + filename);

            // Get the editor content
            const text = editor.getValue();

            // Log the text that is being saved
            console.log("Saving text: " + text);

            // Try to create a file object with the name and content
            try {
                var file = new File(filename, text);

                // Log that the file object was created successfully
                console.log("File object created successfully");
            } catch (error) {
                // Log that an error occurred while creating the file object
                console.error("Error creating file object: " + error.message);
            }

            // Try to store the file in the local storage
            try {
                localStorage.setItem("savedText", text);
                localStorage.setItem(file.name, file.content);

                // Log that the file was stored in the local storage successfully
                console.log("File stored in local storage successfully");
            } catch (error) {
                // Log that an error occurred while storing the file in the local storage
                console.error("Error storing file in local storage: " + error.message);
            }
        }

        function loadText(name) {
            // Log the name of the file that is being loaded
            console.log("Loading file: " + name);

            // Get the saved text from the local storage
            const savedText = localStorage.getItem(name);

            // Check if the saved text exists
            if (savedText) {
                // Log that the file was found in the local storage
                console.log("File found in local storage");

                // Set the editor value to the saved text
                editor.setValue(savedText);
            }
            else {
                // Log that the file was not found in the local storage
                console.log("File not found in local storage");

                // Call the init function
                init();
            }
        }

        function loadTitle() {
            const filename = localStorage.getItem('filename');
            if (filename) {
                console.log(filename)
                title = filename;
            }
        }

        function write(filename) {
            // Get the ACE editor instance
            var editor = ace.edit("editor");
            // Clear the text buffer
            editor.setValue("");
            menuItems[0].text = filename; // append the filename to the first menu item
            console.log(menuItems[0].text)

        }

        function handleStorageChange(event) {
            // Log the event details
            console.log("Storage event:", event);
            // Check the key that was changed
            if (event.key === "filename") {
                // Do something with the new value
                console.log("New value:", event.newValue);
            }
        }

        // Add the listener to the window object
        window.addEventListener("storage", handleStorageChange);
        // Add an event listener to load the saved text when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', loadText);
        // add an event listener to load the title when the DOM loaded
        editor.on('change', saveText);

        async function saveToGitHub(owner, token, repo, filename) {
            const text = editor.getValue(); // Replace this with the method to get the text from your editor
            // Log the owner, token, repo, and filename
            console.log(`Owner: ${owner}, Token: ${token}, Repo: ${repo}, Filename: ${filename}`);
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filename}`;

            // Get the current file content from the repo
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github+json'
                }
            });

            const data = await response.json();

            // Update the file content in the repo
            const updateResponse = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    message: 'Update file content',
                    content: btoa(text),
                    sha: data.sha
                })
            });

            const updateData = await updateResponse.json();

            if (updateResponse.ok) {
                console.log('File saved successfully:', updateData);
            } else {
                console.error('Error saving file:', updateData);
            }
        }

        async function loadTextFileFromGithub(repoOwner, repoName, filePath) {
            console.log(`Loading file from GitHub: repoOwner=${repoOwner}, repoName=${repoName}, filePath=${filePath}`);

            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            console.log(`Fetching file from URL: ${url}`);

            const response = await fetch(url);

            if (!response.ok) {
                const errorMessage = `Failed to load file from ${url}: ${response.status} ${response.statusText}`;
                console.error(errorMessage);
                throw new Error(errorMessage);
            }

            console.log(`File fetched successfully: ${url}`);

            const data = await response.json();

            if (data.type !== 'file') {
                const errorMessage = `Expected ${filePath} to be a file, but got ${data.type}`;
                console.error(errorMessage);
                throw new Error(errorMessage);
            }

            console.log(`File content retrieved successfully: ${filePath}`);

            const content = atob(data.content);

            console.log(`File content decoded successfully`);

            return content;
        }

        function save() {
            const username = localStorage.getItem('username');
            const token = localStorage.getItem('token');
            const repo = localStorage.getItem('repo');
            const filename = localStorage.getItem('filename');
            saveToGitHub(username, token, repo, filename);
            document.title = filename;
        }

        // Menu class definition
        class Menu {
            constructor(items) {
                this.items = items;
                this.menuElement = document.createElement('div');
                // Add text element before the search box
                var title = document.createElement('p');
                title.textContent = localStorage.getItem('filename');
                this.menuElement.appendChild(title);

                // Add event listener to update the search box value when localstorage changes
                window.addEventListener('storage', () => {
                    const filename = localStorage.getItem('filename');
                    if (filename) {
                        this.title.textContent = filename;
                    }
                });

                const searchBox = document.createElement('input');
                this.searchBox = searchBox;
                searchBox.type = 'text';
                searchBox.placeholder = 'Search for options...';
                searchBox.style.width = '100%';
                searchBox.style.padding = 'auto';
                searchBox.style.marginBottom = '10px';
                searchBox.addEventListener('input', () => this.filterItems(searchBox.value));
                // Add an event listener for the 'Enter' key press


                this.menuElement.appendChild(searchBox);

                this.listElement = document.createElement('ul');
                this.listElement.style.listStyleType = 'none';
                this.listElement.style.padding = '0';
                this.listElement.style.margin = '0';
                this.menuElement.appendChild(this.listElement);

                items.forEach(item => this.createItem(item));
            }


            createItem(item) {
                const listItem = document.createElement('li');
                listItem.style.display = 'block';
                listItem.style.padding = 'auto';
                listItem.style.marginBottom = '5px'
                listItem.style.cursor = 'pointer';
                listItem.textContent = item.text;
                listItem.addEventListener('click', item.action);
                this.listElement.appendChild(listItem);
            }

            filterItems(searchText) {
                this.listElement.innerHTML = '';
                this.items
                    .filter(item => item.text.toLowerCase().includes(searchText.toLowerCase()))
                    .forEach(item => this.createItem(item));
            }



            attachTo(element) {
                element.appendChild(this.menuElement);
            }
        }


        // GitInfo class definition
        class GitInfo {
            // Function to create the gitInfoMenu as a div centered on the palette

            constructor() {
                this.element = document.createElement('div');
                this.element.id = 'git-info'; // this is for style reference
                // Create a grid container for the inputs and labels
                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'auto auto';
                grid.style.gridGap = '10px';
                grid.style.alignItems = 'center';
                this.element.appendChild(grid); // Added semicolon
                this.createInput('GitHub Username', 'username', grid);
                this.createInput('GitHub Token', 'token', grid);
                this.createInput('Repository Name', 'repo', grid);
                this.createInput('File Name', 'filename', grid);
                // Create a button element
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                // Add a click event listener to the button
                closeButton.addEventListener('click', () => {
                    // Remove the panel element from its parent
                    this.element.parentNode.removeChild(this.element);
                });
                // Append the button to the panel element
                this.element.appendChild(closeButton);
            }

            createInput(labelText, storageKey, grid) {
                const label = document.createElement('label');
                label.textContent = labelText;
                // Append the label to the grid container
                grid.appendChild(label);

                const input = document.createElement('input');
                input.type = 'text';
                input.value = localStorage.getItem(storageKey) || '';
                input.addEventListener('input', () => localStorage.setItem(storageKey, input.value));
                // Append the input to the grid container
                grid.appendChild(input); // Added semicolon
            }

            saveCredentials() {
                // Save the credentials to localStorage
                const username = localStorage.getItem('username');
                const token = localStorage.getItem('token');
                const repo = localStorage.getItem('repo');
                const filename = localStorage.getItem('filename');
            }

            attachTo(element) {
                element.appendChild(this.element); // Added semicolon
            }



        }
        // Instantiate the GitInfo class
        const gitInfo = new GitInfo();


        // Modify the menuItems array to include the gitInfo element
        var menuItems = [
            {
                text: 'save to git repo',
                action: () => {
                    save();
                }
            },
            {
                text: 'add your git info',
                action: () => {
                    // Create the GitInfoMenu as a child of the palette
                    gitInfo.attachTo(palette.element);
                }
            },
            {
                text: 'files',
                action: () => {
                    dirTree.attachTo(palette.element);
                }
            },
            {
                text: 'new file',
                action: () => {
                    const username = localStorage.getItem('username');
                    const token = localStorage.getItem('token');
                    const repo = localStorage.getItem('repo');
                    const filename = localStorage.getItem('filename');
                    saveToGitHub(username, token, repo, filename); //save the old file
                    newFileMenu.attachTo(palette.element);
                }
            },
            {
                text: 'load from github',
                action: () => {
                    const username = localStorage.getItem('username');
                    const token = localStorage.getItem('token');
                    const repo = localStorage.getItem('repo');
                    const filename = localStorage.getItem('filename');
                    loadTextFileFromGithub(username, repo, filename)
                        .then(content => {
                            editor.setValue(content);
                        })
                        .catch(error => {
                            console.error(error);
                        });


                }
            }
        ];

        const menu = new Menu(menuItems);


        // CommandPalette class definition
        class CommandPalette {
            constructor() {
                this.isOpen = false;
                this.element = null;
            }

            open() {
                if (!this.isOpen) {


                    // Create the overlay element
                    this.overlay = document.createElement('div');
                    this.overlay.style.position = 'fixed';
                    this.overlay.style.top = '0';
                    this.overlay.style.left = '0';
                    this.overlay.style.width = '100%';
                    this.overlay.style.height = '100%';
                    this.overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    this.overlay.style.backdropFilter = 'blur(5px)';
                    this.overlay.style.zIndex = '999';


                    document.body.appendChild(this.overlay);
                    //event listener for closing the overlay
                    this.overlay.addEventListener('click', () => {
                        palette.close();
                    });
                    //make the box
                    this.element = document.createElement('div');
                    this.element.id = 'command-palette';
                    this.element.style.position = 'fixed';
                    this.element.style.top = '50%';
                    this.element.style.left = '50%';
                    this.element.style.transform = 'translate(-50%, -50%)';
                    this.element.style.zIndex = '1000';
                    this.element.style.backgroundColor = 'white';
                    this.element.style.border = '2px solid black';
                    // Add border-radius to make the border rounded at the corners
                    this.element.style.borderRadius = '10px';
                    this.element.style.padding = '10px';
                    this.element.style.width = '30vw';
                    this.element.style.height = '30vh';
                    // Enable vertical scrolling if the content overflows the element's height
                    this.element.style.overflowY = 'auto';

                    this.element.style.display = 'flex';
                    this.element.style.alignItems = 'center';
                    this.element.style.justifyContent = 'center';

                    document.body.appendChild(this.element);
                    // Add the menu to the command palette
                    this.element.appendChild(menu.menuElement);
                    this.isOpen = true;
                }

            }

            close() {
                if (this.isOpen) {
                    document.body.removeChild(this.overlay);
                    document.body.removeChild(this.element);
                    this.isOpen = false;
                }

            }


        }

        // Instantiate the CommandPalette class
        const palette = new CommandPalette();

        async function generateDirectoryTree(username, repo, branch) {
            const url = `https://api.github.com/repos/${username}/${repo}/contents?ref=${branch}`;
            console.log(`https://api.github.com/repos/${username}/${repo}/contents?ref=${branch}`);
            const response = await fetch(url, {
                headers: {
                    Accept: 'application/vnd.github.v3+json',
                },
            });
            const data = await response.json();

            const tree = { name: repo, type: 'folder', children: [] };

            for (let item of data) {
                const path = item.path.split('/');
                let parent = tree;
                for (let i = 0; i < path.length - 1; i++) {
                    const folderName = path[i];
                    let folder = parent.children.find(child => child.name === folderName);
                    if (!folder) {
                        folder = { name: folderName, type: 'folder', children: [] };
                        parent.children.push(folder);
                    }
                    parent = folder;
                }

                const fileName = path[path.length - 1];
                if (item.type === 'file') {
                    parent.children.push({ name: fileName, type: 'file' });
                } else if (item.type === 'dir') {
                    const folder = { name: fileName, type: 'folder', children: [] };
                    parent.children.push(folder);

                    const subDirectory = await generateDirectoryTree(owner, repo, `${branch}:${item.path}`);
                    folder.children = subDirectory.children;
                }
            }

            return tree;
        }

        class DirectoryTreeDisplay {
            constructor(containerElement, treeData) {
                console.log('constructing dir tree');
                this.element = document.createElement('div');
                const username = localStorage.getItem('username');
                const repo = localStorage.getItem('repo');
                const branch = 'main'; // this is dumb and silly but we're hardcoding this for now. holy shit I'm so sleepy that I named it 'branch' instead of main. holy fuck
                this.treeData = generateDirectoryTree(username, repo, branch);
            }

            render() {
                const tree = this.buildTree(this.treeData);
                this.containerElement.appendChild(tree);
            }

            buildTree(data) {
                const tree = document.createElement('ul');
                tree.classList.add('directory-tree');

                for (const item of data) {
                    const li = document.createElement('li');
                    const name = document.createElement('span');
                    name.innerText = item.name;
                    li.appendChild(name);

                    if (item.type === 'tree') {
                        const subtree = this.buildTree(item.children);
                        li.appendChild(subtree);
                    }

                    tree.appendChild(li);
                }

                return tree;
            }
            attachTo(element) {
                element.appendChild(this.element);
            }
        }
        const dirTree = new DirectoryTreeDisplay();

        class NewFileMenu {
            constructor() {
                this.element = document.createElement('div');
                this.element.id = 'new-file';
                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'auto auto';
                grid.style.gridGap = '10px';
                grid.style.alignItems = 'center';
                this.element.appendChild(grid); // Added semicolon

                this.createInput('new file: ', 'filename', grid)
                // Create a button element
                const closeButton = document.createElement('button');
                closeButton.textContent = 'make new file';
                // Add a click event listener to the button
                closeButton.addEventListener('click', () => {
                    // Remove the panel element from its parent
                    var filename = localStorage.getItem('filename')
                    this.element.parentNode.removeChild(this.element);
                    write(filename);
                });
                // Append the button to the panel element
                this.element.appendChild(closeButton);
            }

            createInput(labelText, storageKey, grid) {
                const label = document.createElement('label');
                label.textContent = labelText;
                // Append the label to the grid container
                grid.appendChild(label);

                const input = document.createElement('input');
                input.type = 'text';
                input.value = localStorage.getItem(storageKey) || '';
                input.addEventListener('input', () => localStorage.setItem(storageKey, input.value));
                // Append the input to the grid container
                grid.appendChild(input); // Added semicolon
            }

            attachTo(element) {
                element.appendChild(this.element); // Added semicolon
            }


        }

        const newFileMenu = new NewFileMenu();
        // Add an event listener for keydown events
        document.addEventListener('keydown', (event) => {
            // Check if the cmd+space keys are pressed
            if ((event.metaKey || event.ctrlKey) && event.code === 'Space') {
                if (palette.isOpen) {
                    palette.close();
                } else {
                    palette.open();
                }

            }

        });


    </script>
</body>

</html>