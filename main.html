<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>webprose</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"
        integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q=="
        crossorigin="anonymous"></script>
</head>

<body>


    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <button id="menu-button">Menu</button>

    <ul id="menu">
        <li id="top">Files
            <ul class="submenu" id="files"></ul>
        </li>

        <li id="top">Info
            <ul class="submenu" id="info">
                <li id="git-form">
                    <div>
                        <input type="text" name="username" placeholder="Enter your Git username">
                        <input type="text" name="token" placeholder="Enter your Access Token">
                        <input type="text" name="repo" placeholder="Enter your Git repo">
                    </div>
                </li>
            </ul>
        </li>
        <li id="sync-button">
            $ync with Git
        </li>
        <li>Customize</li>
        <li>save files with ctrl+s.</li>
        <li>The first line is the filename.</li>
        <li>Reload the page to refresh the file list.</li>
        <li>
            <div id="throbber">

                <p>
                    <img id="hourglass" src="./throbber.gif">
                    saving...
                </p>
            </div>
        </li>
    </ul>
    <script>
        //define functions to put and retrieve data to github + a listener for the github sync button and a function that syncs everything up real nice
        
        //get the list of files from localstorage.
        function listFiles() {
            var list = [];
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                list.push(key);
            }
            return list;
            console.log(list);
        }

        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/text");
        editor.setKeyboardHandler("ace/keyboard/vim");
        editor.renderer.setShowGutter(false);
        editor.commands.addCommand({
            name: 'save',
            bindKey: { win: 'Ctrl-S', mac: 'Cmd-S' },
            exec: function (editor) {
                save(editor.getValue());
            },
            readOnly: true // false if this command should not apply in readOnly mode
        });

        editor.setOptions({
            showInvisibles: false, // Disable display of invisible characters
            tabSize: 4,
            printMargin: false,
            fontSize: 24,
            indentedSoftWrap: false,
            wrap: "free",
            fontFamily: 'iawriter'

        })

        ace.config.loadModule("ace/keybinding/vim", function () { // Use Vim Here
            Vim = require("ace/keyboard/vim").Vim
            Vim.map("j", "gj", "normal")
            Vim.map("k", "gk", "normal")
        })

        function save(text) {
            const title = makeTitle(text);
            localStorage.setItem(title, text);
            listFiles();
            // add the title to the file list in localstorage
            let throbber = document.getElementById("throbber"); // get the throbber element by ID on the DOM
            throbber.classList.toggle("invisible"); //this adds the 'visible' class to the throbber if it doesn't have it.
            setTimeout(function () {
                throbber.classList.toggle("invisible"); // after a second of visibility, invert the visible state.
            }, 3000);
            console.log('saving...')

        }

        setInterval(function () {
            save(editor.getValue());
            //make an element visible for a second, then invisible. assume it's hidden by default
        }, 4000);

        function makeTitle(text) {
            let strings = text.split("\n");
            let title = strings[0];
            return title;
        }

        // Get the button and the menu elements
        let menuButton = document.getElementById("menu-button");
        let menu = document.getElementById("menu");

        // Add a click event listener to the button
        menuButton.addEventListener("click", function () {
            // Toggle the open class on the menu
            menu.classList.toggle("open");
            menuButton.classList.toggle("button-open");
            console.log("clicked");
        });

        buildFileMenu();

        function buildFileMenu() {
            // Get all menu items that have a submenu
            let menuItems = document.querySelectorAll("#menu > li");

            // Loop through each menu item
            for (let menuItem of menuItems) {
                // Get the submenu of the current menu item
                let submenu = menuItem.querySelector(".submenu");

                // Check if there is a submenu
                if (submenu) {
                    // Add a click event listener to the menu item
                    menuItem.addEventListener("click", function () {
                        // Toggle the active class on the submenu
                        submenu.classList.toggle("active");
                    });

                    stopMenuProp(submenu); //prevent clicks on the submenu from propagating to the upper menu and closing everythign

                }
                if (submenu && submenu.id == "files") {
                    console.log("there is a file menu");
                    let files = listFiles();
                    for (let file of files) {
                        if (file) {
                            console.log(file)
                            var text = document.createTextNode(file);
                            var li = document.createElement('li');
                            li.appendChild(text);
                            submenu.appendChild(li);
                            stopMenuProp(submenu);
                            // add event listener to li
                            li.addEventListener("click", function () {
                                // get the text value of li
                                var key = this.textContent;
                                // load the file from localStorage
                                var fileContent = localStorage.getItem(key);
                                // do something with fileContent
                                editor.setValue(fileContent);
                            });
                        }
                    }
                }
            }
        }

        // Define a function that updates the file list menu
        function updateFileListMenu() {
            // Select the submenu element with the id "files"
            let submenu = document.getElementById("files");
            // Check if there is such an element
            if (submenu) {
                // Clear the submenu content
                submenu.innerHTML = "";
                // Get the files from localStorage
                let files = listFiles();
                // Loop through each file
                for (let file of files) {
                    // Check if the file is not empty
                    if (file) {
                        // Create a text node with the file name
                        var text = document.createTextNode(file);
                        // Create an li element
                        var li = document.createElement('li');
                        // Append the text node to the li element
                        li.appendChild(text);
                        // Append the li element to the submenu
                        submenu.appendChild(li);
                        // Stop the event propagation on the li element
                        stopMenuProp(li);
                    }
                }
            }
        }

        // Add a storage event listener to call the function when localStorage changes
        window.addEventListener("storage", updateFileListMenu);

        function stopMenuProp(submenu) {
            // Get all the submenu items
            let submenuItems = submenu.querySelectorAll("li");

            // Loop through each submenu item
            for (let submenuItem of submenuItems) {
                // Add a click event listener to the submenu item
                submenuItem.addEventListener("click", function (event) {
                    // Stop the event propagation to the parent menu item
                    event.stopPropagation();
                });
            }
        }
    </script>


</body>

</html>